# Документация по скрипту load_zav_file.m

## Описание

Скрипт `load_zav_file.m` предназначен для загрузки ZAV файлов с сохранением всей функциональности из основного приложения EasyView. Он обеспечивает полную совместимость с оригинальным кодом и может использоваться как самостоятельно, так и в составе других проектов.

## Основные возможности

- ✅ Загрузка ZAV файлов (.mat)
- ✅ Автоматическое определение и конвертация формата Heka
- ✅ Обработка данных со свипами
- ✅ Извлечение стимулов
- ✅ Загрузка событий (опционально)
- ✅ Загрузка настроек каналов (опционально)
- ✅ Автоматическая настройка временных параметров
- ✅ Подробное логирование процесса загрузки

## Синтаксис

```matlab
[lfp, spks, hd, zavp, lfpVar, chnlGrp, time, stims, sweep_info, events, event_comments, event_amplitudes, event_channels, event_widths, event_prominences, event_metadata] = load_zav_file(filepath, varargin)
```

## Входные параметры

### Обязательные
- `filepath` - путь к .mat файлу (ZAV или Heka формат)

### Опциональные (varargin)
- `'load_events'` - загружать ли события (по умолчанию `false`)
- `'load_settings'` - загружать ли настройки каналов (по умолчанию `false`)
- `'auto_set_time_windows'` - автоматически устанавливать временные окна для свипов (по умолчанию `true`)
- `'auto_set_fs'` - автоматически устанавливать newFs на основе Fs (по умолчанию `true`)

## Выходные параметры

### Основные данные
- `lfp` - матрица LFP данных
- `spks` - данные спайков
- `hd` - заголовок записи
- `zavp` - параметры ZAV
- `lfpVar` - вариация LFP
- `chnlGrp` - группы каналов

### Временные параметры
- `time` - временная ось
- `stims` - времена стимулов
- `sweep_info` - информация о свипах

### События (если загружались)
- `events` - времена событий
- `event_comments` - комментарии к событиям
- `event_amplitudes` - амплитуды событий
- `event_channels` - каналы событий
- `event_widths` - ширина пиков событий
- `event_prominences` - выраженность пиков событий
- `event_metadata` - метаданные событий

## Примеры использования

### 1. Базовая загрузка файла
```matlab
[lfp, spks, hd, zavp, lfpVar, chnlGrp, time, stims, sweep_info] = load_zav_file('data.mat');
```

### 2. Загрузка с событиями
```matlab
[lfp, spks, hd, zavp, lfpVar, chnlGrp, time, stims, sweep_info, events] = load_zav_file('data.mat', 'load_events', true);
```

### 3. Загрузка с настройками каналов
```matlab
[lfp, spks, hd, zavp, lfpVar, chnlGrp, time, stims, sweep_info, events, event_comments, event_amplitudes, event_channels, event_widths, event_prominences, event_metadata, channelNames, channelEnabled, scalingCoefficients, colorsIn, lineCoefficients, mean_group_ch, csd_avaliable, filter_avaliable, filterSettings] = load_zav_file('data.mat', 'load_events', true, 'load_settings', true);
```

### 4. Отключение автоматических настроек
```matlab
[lfp, spks, hd, zavp, lfpVar, chnlGrp, time, stims, sweep_info] = load_zav_file('data.mat', 'auto_set_time_windows', false, 'auto_set_fs', false);
```

## Особенности работы

### Автоматическое определение формата
Скрипт автоматически определяет формат файла:
- Если это формат Heka - автоматически конвертирует в ZAV
- Если это ZAV формат - загружает напрямую

### Обработка свипов
- Автоматически определяет наличие свипов в данных
- Обрабатывает данные через `sweepProcessData`
- Устанавливает соответствующие временные параметры

### Временные параметры
- Автоматически создает временную ось на основе частоты дискретизации
- Для свипов автоматически устанавливает временные окна
- Поддерживает ручную настройку через параметры

### Стимулы
- Извлекает стимулы из `zavp.realStim`
- Поддерживает как данные со свипами, так и без них

## Зависимости

Скрипт использует следующие функции из EasyView:
- `detectHekaFormat` - определение формата Heka
- `hekaToZav` - конвертация Heka в ZAV
- `sweepProcessData` - обработка данных со свипами
- `np_flatten` - обработка массивов

## Обработка ошибок

Скрипт включает встроенную обработку ошибок:
- Проверка существования файла
- Try-catch блоки для загрузки событий и настроек
- Предупреждения при загрузке старых форматов
- Создание настроек по умолчанию при ошибках

## Логирование

Скрипт выводит подробную информацию о процессе загрузки:
- Название загружаемого файла
- Обнаруженный формат
- Параметры данных (размеры, частота дискретизации)
- Информация о свипах и стимулах
- Итоговая сводка

## Совместимость

- Полностью совместим с EasyView v1.11.02
- Поддерживает старые и новые форматы настроек каналов
- Обратная совместимость с форматами событий
- Работает с данными со свипами и без них

## Файлы

- `load_zav_file.m` - основной скрипт загрузки
- `example_load_zav.m` - примеры использования
- `README_load_zav.md` - данная документация

## Примечания

1. Скрипт создает временные переменные, которые не конфликтуют с глобальными переменными EasyView
2. Все функции EasyView должны быть доступны в текущем пути MATLAB
3. При загрузке настроек каналов создаются переменные, которые можно использовать для дальнейшей работы
4. Скрипт автоматически обрабатывает различные сценарии загрузки данных 